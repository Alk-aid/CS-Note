# 1. 看门狗

> redlock工业上有争议

看门狗解决的问题:



- 假如有一个业务,它需要分布式锁,但是它的执行时间可能是一分钟，也可能是八分钟, 这个时候怎么设置过期时间

  

  

  

# 2. 线上排查

# 3. 写库 & 发消息

1. 前端点一下, 服务端耗时很长, 所以希望在5s内只处理一次

>使用分布式锁实现
>
>- 把前端的请求参数作为key, 然后使用redis分布式锁 设置超时时间为5s
>- 其他请求没拿到锁就直接返回, 因为redis分布式锁 不阻塞(set if not exist, 也就是**只有不存在的时候才设置, 设置成功时返回1**)

2. 写库, 然后发消息, 写完库, 发消息前机器挂掉了怎么办

> 1. 保证这两步的原子性
> 2. 定时对账, 对不上就回滚

3. 保证幂等

> 情况: 消息队列会有重复投递的问题, 这时候后端需要保证幂等
>
> - 使用messageid作为key，过期时间为5分钟
> - 然后再去做业务
> - 业务做完以后将messigeid放到redis中

# 4. 优雅下线