# 1. IP：网际协议

## 1.1 概述

**IP层和MAC层的区别：**

- IP层是实现主机与主机之间的通信，源主机发送的IP包会最终到达目的主机，所以是实现主机到主机的通信。
- MAC是实现同一个链路的通信，源主机发送的MAC包很大可能到达不了目的主机，而只能到达同一网络的路由器，而路由器发出来的MAC包又和源主机不同。

**IP层的特点**：

- 不可靠：发送错误，会丢弃数据包，然后返回一个ICMP消息
- 无连接：不维护任何关于后续数据报的状态信息。

**IPV4和IPV6:**

- IPV4的地址是32位,IPV6是128的
- IPV6是以16位作为一组的，每组用 ： 隔开

## 1.2 IP层的首部

普通的IP首部是20字节。

![image-20210912204316381](http://aikaid-img.oss-cn-shanghai.aliyuncs.com/img/image-20210912204316381.png)

| 版本(4位)                       | 首部长度(4位)                                                | 服务类型(8位)                | 总长度(16位) |
| ------------------------------- | ------------------------------------------------------------ | ---------------------------- | ------------ |
| IPV4的版本号为4                 | 单位为4字节，一般首部长度为5(20字节)                         |                              | 总长度       |
|                                 |                                                              |                              |              |
| 16位标识                        | 3位标志                                                      | 13位片偏移                   |              |
| 同一个分片的标识值相同；        | 第0位未使用<br>第1位是 dont`t fragment<br>第2位是 more fragment | 每个分片相对于原始数据的位置 |              |
|                                 |                                                              |                              |              |
| 8位生存时间                     | 8位协议                                                      | 16位首部检验和               |              |
| 可以中转多少个路由器，为0就抛弃 | 上一层使用的协议是什么                                       | 只校验首部，不校验数据部分   |              |
|                                 |                                                              |                              |              |
| 32位源IP                        |                                                              | 32位目的IP                   |              |

## 1.3 IP地址

**ABCD四类地址**

- A类地址1-8位为网络地址（0）; B类地址1-16位为网络地址（10）; C类地址1-24位为网络地址（110）; D类地址1-32位为网络地址，没有主机地址（1110，常用于多播）

**特殊IP**

- `环回地址`：127.X.X.X。环回地址允许在同一台主机上进行TCP/IP通信。
- `本网络地址`： 网络号全为0，格式为{0, <Host-number>};全为0表示本网络本主机
- `受限广播地址`：在本网络内部进行广播{255.255.255.255}
- `直接广播地址`：向某个网络上所有的主机发送报文：{<Network-number>, -1}；
- `网络地址`：每个网络都有一个IP地址{<Network-number>，0}

**CIDR**：

- 消除了传统的ABCD类地址以及子网划分的概念。
- CIDR没有子网是指没有在32位地址指明子网字段，分配到的一个CIDR组织仍然可以在本组织内部根据需要划分出子网。

## 1.4 路由

路由表必须包含以下三项内容

- 目的网络地址
- 子网掩码
- 下一跳地址

![image-20210914000508644](http://aikaid-img.oss-cn-shanghai.aliyuncs.com/img/image-20210914000508644.png)

# 2. ARP

Address Resolution Protocol

- 只适用于IPV4；是为IP地址找到对应的MAC地址

**工作流程**：

- 每个主机都有一个MAC地址缓存(ARP表)，如果缓存没找到；则源主机发送ARP请求；
- 如果某个结点发现APR包中的目标IP和自己的IP相同，则这个节点就将自己的MAC地址塞入ARP响应中返回给源主机,

# 3. ICMP

Internet Control Message Protocol：互联网控制报文协议

ICMP的主要功能：

- 确认IP包是否成功送达目的地址;(*查询报文*)
- 通知在发送过程当作IP包被丢弃的具体原因，改善网络设置等。(*差错报文*)

Ping

- 属于查询报文，目的是为了测试本主机是否可达另一台主机。
- 该程序发送一份`ICMP回送请求报文`(8)给目的主机，并等待返回`ICMP回送应答报文`(0)。
- ICMP回送请求数据报包含了进程的PID，序号(每发送一个请求，序列号会加1，从1开始),发送请求的时间等信息（来计算往返时间）
- 接收过程就是构造ICMP回送响应报文，其中的序号为接收到的请求包中的序号

Traceroute

- 用了ICMP的差错报文和IP包的TTL字段。

> 附加：IP包设置TTL的目的是：为了在路由控制遇到问题发生循环状况时，避免IP包无休止地在网络上被转发。（和本题无关）

- 利用ttl从1开始按照顺序递增的方式来发送UDP包。
- 路由器接收到ttl为1的数据报时，构造一个ICMP差错报文，其中数据部分有路由器的IP地址
- 目的主机接收到ttl为1的数据报时，会接收该包，但是发现目的主机的任何一个应用程序都不可能使用UDP包中的端口号，因此回送一个“端口不可达”的ICMP报文。
- Traceroute程序所要做的就是区分接收到的ICMP报文是超时还是端口不可达，以判断什么时候结束。
- 作用：追踪去往目的地沿途所经过的路由器； 故意设置不分片，从而确定路径的MTU

**路径MTU**： 路径中存在的所有数据链路中最小的MTU

- 找到路径MTU以后，就可以在主机进行分片，路由器不必进行分片
- 可以用traceroute来确定路径MTU。
- 将IP数据报首部的分片禁止标志位置为1，这样路由器在遇到要分片才能处理的包时，不会进行分片，而是丢弃，然后传送一个ICMP的不可达消息（其中包含该数据链路层的MTU）给源主机。
- 重复几次，直到不收到ICMP为止，此时得到的MTU就是路径MTU

# 4. DNS(*Domain Name System*)

`作用`：DNS将域名解析为具体的IP地址。

`服务器分类`: 根DNS服务器,顶级域DNS服务器, 权威DNS服务器, 本地DNS服务器

- 根域的DNS服务器信息保存在互联网所有的DNS服务器中。这样一来任何DNS服务器都可以找到并访问根域DNS服务器。

`工作流程`: 

- 客户机发出查询请求，会先在浏览器，本地的hosts文件，路由器里面查找缓存，若没有找到，就会将请求发送给本地dns服务器

- 本地DNS服务器收到请求以后

  - 如果缓存的表格中能直接找到，则直接返回IP地址

  - 否则本地DNS服务器去询问根DNS服务器，根DNS服务器会返回对应的顶级域DNS服务器地址

- 本地DNS随后询问顶级域服务器。顶级域返回权威DNS服务器地址

- 本地DNS询问权威DNS服务器，权威DNS服务器则返回域名对应的IP地址给本地DNS

- 本地DNS将IP地址返回给客户端

`迭代和递归`:

- 主机向本地域名服务器为递归查询：客户端只发一次请求，要求对方给出最终结果。
- 本地域名服务器向根域名服务器使用迭代查询：客户端发出一次请求，要么给出所要查询的IP地址，要么告诉本地服务器：“你下一步应当向哪一个域名服务器进行查询”。

`DNS负载均衡`

- 一般大公司都有成百上千台服务器来支撑访问，DNS可以返回一个**合适的机器的IP**给用户
- 例如可以**根据每台机器的负载量，该机器离用户地理位置的距离**等等，这种过程就是DNS负载均衡。

# 5. DHCP

Dynamic Host Configuration Protocol

- 通过DHCP动态获取IP地址。
- DHCP客户端进程监听的端口是68，服务器监听的端口是67

步骤

- 客户端首先发起`DHCP发现报文`的IP数据报，由于客户端没有IP地址，也不知道DHCP服务器的地址。所以使用的UDP广播通信。其中源IP地址为0.0.0.0(端口68),目的地址为255.255.255.255(端口为67)
- DHCP服务器收到`DHCP发现报文`时，用`DHCP提供报文`向客户端做出回应。其中源IP地址为服务器IP，目标IP地址仍为255.255.255.255.其中报文信息携带了`可租约的IP地址`,`IP地址租用期`，`子网掩码`,`默认网关`,`DNS服务器`
- DHCP客户端收到一个至多个服务器的`DHCP提供报文`,从中选择一个服务器，并向选中的服务器发送`DHCP请求报文`
- 最后，服务器用`DHCP ACK报文`对DHCP请求报文进行响应。

一旦客户端收到DHCP ACK后，交互就完成了，客户端就可以使用分配的IP地址了。

如果续约的DHCP IP地址快到期了，客户端向服务器发送`DHCP请求报文`

- 服务器发送DHCP ACK来同意

- 发送DHCP NACK来不同意

# 6. NAT

Network Address Translation

- NAT把私有地址转换为公有地址。同一个网络里面就可以共用同一个公网地址，通过端口号来进行区分。
- 其中的对应关系存储在转换表中。转换表是自动生成的。如TCP在首次握手发送SYN包的时候就会生成这个表。在FIN包发送的适合将表项从数据中删除。

![image-20220118185144093](http://aikaid-img.oss-cn-shanghai.aliyuncs.com/img/image-20220118185144093.png)

缺点：

- 外部无法主动和NAT内部服务器建立连接，因为NAPT转换表没有转换记录

- 转换表的生成和转换操作都是耗时的

- 如果NAT路由器重启了，所有的TCP连接都需要重置。

解决

- 改用IPV6
- NAT穿透技术: 让应用程序主动发现自己位于NAT设备之中，并且会主动获取NAT设备的公有IP地址，并为自己建立端口映射条目然后用这个条目对外通信，就不需要NAT设备来进行转换了





