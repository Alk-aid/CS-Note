1. 文件的定义：一组有意义的信息的集合
2. 文件内部应该如何被组织起来：`文件的逻辑结构`
3. 文件之间应该如何被组织起来:`目录结构`
4. 文件应该如何存放在外存中:`文件的物理结构`

# 1. 文件和文件系统

<img src="http://aikaid-img.oss-cn-shanghai.aliyuncs.com/img/image-20220419222552947.png" alt="image-20220419222552947" style="zoom:50%;" />

![image-20210910165423177](http://aikaid-img.oss-cn-shanghai.aliyuncs.com/img/image-20210910165423177.png)

![image-20210910165448575](https://gitee.com/aik-aid/picture/raw/master/image-20210910165448575.png)

# 2. 文件的逻辑结构

文件的逻辑结构分为

1. `无结构文件`：文件内部的数据就是一系列二进制流或者字符流的组成，又称为“流式文件”(如txt文件)
2. `有结构文件`：由一组相似的记录组成，又称“记录式文件”。每条记录又若干个数据项组成。如：数据库表文件。也可分为`定长文件`和`可变长文件`
   1. 顺序文件： **一系列记录按某种顺序排列形成**
   2. 索引文件： **记录为变长，**每个记录一个索引表项
   3. 索引顺序文件： **每组**记录的第一个记录设一表项

> **UNIX**系统中所有文件都被看作是流式文件

## 2.1 顺序文件

顺序文件：文件中的记录一个接一个地顺序排列（`逻辑上`），记录可以是`定长的`或`可变长的`。各个记录在物理上可以`顺序存储`或`链式存储`。

顺序文件还可以分为

- 串结构： 以时间排序
- 顺序结构：按关键字进行排序

优点：

- 有利于大批记录读写
- 存取效率最高
- 可存储在顺序存储设备(磁带)上

缺点：

- 查找或修改单个记录：差
- 增删一个记录：难

![image-20210909123928145](https://gitee.com/aik-aid/picture/raw/master/image-20210909123928145.png)

## 2.2 索引文件

如果文件是可变长的，可是我们又想快速查找，那么我们就可以使用索引文件

那么就为文件建立一个索引表来加快文件检索速度。其中每条记录对应一个索引项。

索引表本身是`定长记录的顺序文件`。因此可以快速找到第i个记录对应的索引项。

![image-20210909124702539](https://gitee.com/aik-aid/picture/raw/master/image-20210909124702539.png)



## 2.3 索引顺序文件

索引顺序文件是索引文件和顺序文件思想的结合。索引顺序文件中，同样会为文件建立一张索引表，但不同的是：并不是每个记录对应一个索引表项，而是`一组记录对应一个索引表项`。

先索引再顺序

![image-20210910134944558](https://gitee.com/aik-aid/picture/raw/master/image-20210910134944558.png)

为了进一步提高检索效率，可以为顺序文件建立多级索引表。例如，对于一个含1000,000个记录的文件，可先为该文件建立一张低级索引表，每100个记录为一组，故低级索引表中共有1000,0个表项（即1000,0个定长记录），再把这1000,0个定长记录分组，每组100个，为其建立顶级索引表，故顶级索引表中共有100个表项。

![image-20220419224500492](http://aikaid-img.oss-cn-shanghai.aliyuncs.com/img/image-20220419224500492.png)

## 2.4 直接文件

![image-20220419224644262](http://aikaid-img.oss-cn-shanghai.aliyuncs.com/img/image-20220419224644262.png)

哈希文件

![image-20220419224717016](http://aikaid-img.oss-cn-shanghai.aliyuncs.com/img/image-20220419224717016.png)

# 3. 文件目录

`目录项`: 记录了从文件名到inode号的映射

`目录`：由一个个目录项组成的特殊文件

> **目录**：用于标识系统中文件及其物理地址的一种数据结构，供检索使用

![image-20210909142909715](http://aikaid-img.oss-cn-shanghai.aliyuncs.com/img/image-20210909142909715.png)

## 3.1 文件控制块

**实现文件目录的关键数据结构**

目录本身就是一种**有结构文件**，由一条条记录组成。每条记录对应一个在该放在该目录下的文件。

**文件控制块**。文件控制块(FCB)是用来`存放控制文件需要的各种信息`的数据结构，以实现`“按名存取”`。

FCB的有序集合称为文件目录，一个FCB就是一个`文件目录项`。为了创建一个新文件，系统将分配一一个FCB并存放在文件目录中，成为目录项。

**FCB**包含的信息项

- 基本信息： 
- 存取控制信息类
- 使用信息类

![image-20210909140843501](https://gitee.com/aik-aid/picture/raw/master/image-20210909140843501.png)

## 3.2 索引节点

索引节点的引入

<img src="http://aikaid-img.oss-cn-shanghai.aliyuncs.com/img/image-20220419225728131.png" alt="image-20220419225728131" style="zoom:50%;" />



![image-20220419225904842](http://aikaid-img.oss-cn-shanghai.aliyuncs.com/img/image-20220419225904842.png)

存放在外存中的索引结点称为“磁盘索引结点”，当索引结点放入内存后称为“内存索引结点”。

相比之下内存索引结点中需要增加一些信息，比如：文件是否被修改、此时有几个进程正在访问该文件等。

## 3.3 目录结构

### 3.3.1 单级目录结构

整个文件系统建立一个目录表，每个文件占一个目录项

- 单级目录实现了“按名存取”，但是不允许文件重名。

- 显然，单级目录结构不适用于多用户操作系统。

### 3.3.2 两级目录结构

早期的多用户操作系统，采用两级目录结构。分为`主文件目录`（MFD，Master File Directory）和`用户文件目录`（UFD，User Flie Directory）。

**主文件目录**记录用户名及相应用户文件目录的存放位置

**用户文件目录**由该用户的文件FCB组成

两级目录结构允许不同用户的文件重名，也可以在目录上实现实现访问限制（检查此时登录的用户名是否匹配）。但是两级目录结构依然缺乏灵活性，用户不能对自己的文件进行分类

### 3.3.3 多级目录结构(树形目录结构)

树形目录结构可以很方便地对文件进行分类，层次结构清晰，也能够更有效地进行文件的管理和保护

![image-20220419230459912](http://aikaid-img.oss-cn-shanghai.aliyuncs.com/img/image-20220419230459912.png)

### 3.3.4 无环图目录结构

**树形结构不便于实现文件的共享**。为此，提出了“无环图目录结构”。

![image-20210909142153777](https://gitee.com/aik-aid/picture/raw/master/image-20210909142153777.png)

**可以用不同的文件名指向同一个文件，**甚至可以指向同一个目录（共享同一目录下的所有内容）。

需要为每个共享结点设置一个**共享计数器**，用于记录此时有多少个地方在共享该结点。用户提出删除结点的请求时，只是删除该用户的FCB、并使共享计数器减1，并不会直接删除共享结点。**只有共享计数器减为0时，才删除结点。**

## 3.4 目录查询技术

线性检索法：

![image-20220419230833677](http://aikaid-img.oss-cn-shanghai.aliyuncs.com/img/image-20220419230833677.png)

hash方法：

![image-20220419230858824](http://aikaid-img.oss-cn-shanghai.aliyuncs.com/img/image-20220419230858824.png)

![image-20220419230918421](http://aikaid-img.oss-cn-shanghai.aliyuncs.com/img/image-20220419230918421.png)

# 4. 文件共享

硬链接 `ln file link` 和软连接  `ln -s file slink`

- 硬链接是创建一个目录项，指向源文件的index node；软链接是会创建一个保存着目标文件路径的文件，所以软连接会创建对应的文件，index node， 目录项；
- 硬链接的link 和 file是同等地位的，一个删了另外一个还能用；软连接的话，删除源文件，软连接就不能用。
- 软链接文件除了创建，删除和更新元数据以外，其本身只支持读取操作。

## 4.1 硬链接(基于索引结点的共享方式)

![image-20210910102607199](https://gitee.com/aik-aid/picture/raw/master/image-20210910102607199.png)

## 4.2 软链接(基于符号链的共享方式)

![image-20210910102636663](https://gitee.com/aik-aid/picture/raw/master/image-20210910102636663.png)

用软连接要查询多级目录，会有多次磁盘I/O，因此比硬链接要慢

# 5. 文件保护

分为

- 口令保护
- 加密保护
- 访问控制

## 4.1 口令保护

为文件设置一个“口令”（如：abc112233），用户请求访问该文件时必须提供“口令”。口令一般存放在文件对应的`FCB`或`索引结点`中。用户访问文件前需要先输入“口令”，操作系统会将用户提供的口令与FCB中存储的口令进行对比，如果正确，则允许该用户访问文件

优点：保存口令的空间开销不多，验证口令的时间开销也很小。

缺点：正确的“口令”存放在系统内部，不够安全。

## 4.2 加密保护

使用某个“密码”对文件进行加密，在访问文件时需要提供正确的“密码”才能对文件进行正确的解密。

![image-20210910101619014](https://gitee.com/aik-aid/picture/raw/master/image-20210910101619014.png)

优点：保密性强，不需要在系统中存储“密码”
缺点：编码/译码，或者说加密/解密要花费一定时间。

## 4.3 访问控制

在每个文件的FCB（或索引结点）中增加一个访问控制列表（Access-Control List, ACL），该表中记
录了各个用户可以对该文件执行哪些操作。

有的计算机可能会有很多个用户，因此访问控制列表可能会很大，可以用`精简的访问列表`解决这个问题

精简的访问列表：以“组”为单位，标记各“组”用户可以对文件执行哪些操作。如：分为系统管理员、文件主、文件主的伙伴、其他用户几个分组。当某用户想要访问文件时，系统会检查该用户所属的分组是否有相应的访问权限。

# 6. 外存组织方式(文件的物理结构)

![image-20210910135636622](https://gitee.com/aik-aid/picture/raw/master/image-20210910135636622.png)

> 探讨的是对于非空闲磁盘块的管理(文件的物理结构/文件的分配方式)
>
> 对空闲块磁盘块的管理是`文件存储空间要讨论的问题`
>

用户通过逻辑地址来操作自己的文件，操作系统要负责实现从逻辑地址到物理地址的映射

- 连续分配 ---- 顺序式文件结构
- 链接分配 ---- 链接式文件结构
- 索引分配 ---- 索引式文件结构

## 6.1 连续分配

**连续分配方式要求每个文件在磁盘上占有一组连续的块。**

用户给出要访问的文件(`按名存取`)，操作系统找到该文件对应的目录项（FCB）,从而找到起始块在物理上的地址。从而得出 **物理块号=起始块号+逻辑块号**
当然，还需要检查用户提供的逻辑块号是否合法（逻辑块号≥ 长度就不合法）

![image-20210910105409510](https://gitee.com/aik-aid/picture/raw/master/image-20210910105409510.png)

优点：

1. 支持顺序访问和直接访问（即随机访问）
2. 连续分配的文件在顺序读/写时速度最快（读取某个磁盘块时，需要移动磁头。访问的两个磁盘块相隔越远，移动磁头所需时间就越长）

缺点：

1. 物理上采用连续分配的文件不方便拓展。
2. 存储空间利用率低，会产生难以利用的磁盘碎片

> 若此时文件A要拓展，需要再增加一个磁盘块（总共需要连续的4个磁盘块）。由于采用连续结构，因此文件A占用的磁盘块必须是连续的。因此只能将文件A全部“迁移”到绿色区

## 6.2 链接分配

链接分配采取`离散分配`的方式，可以为文件分配离散的磁盘块。分为`隐式链接`和`显式链接`两种。

### 6.2.1 隐式链接

隐式链接——除文件的最后一个盘块之外，每个盘块中都存有指向下一个盘块的指针。文件目录包括文件第一块的指针和最后一块的指针。

![image-20210910105916568](https://gitee.com/aik-aid/picture/raw/master/image-20210910105916568.png)

根据文件名找到FCB，从而找到对应的物理块号。

从目录项中找到起始块号（即0号块），将0号`逻辑块`读入内存，由此知道1号`逻辑块`存放的物理块号，于是读入1号逻辑块，再找到2号逻辑块的存放位置……以此类推。因此，读入i号逻辑块，总共需要i+1次磁盘I/O。

- 优点：很方便文件拓展，不会有碎片问题，外存利用率高。
- 缺点：只支持顺序访问，不支持随机访问，查找效率低，指向下一个盘块的指针也需要耗费少量的存储空间。

### 6.2.2 显示链接

把用于链接文件各物理块的指针显式地存放在一张表中。即文件分配表（FAT，File Allocation Tale）

注意：一**个磁盘仅设置一张FAT**（索引分配是为每个文件分配一个表）。开机时，将FAT读入内存，并`常驻内存`。FAT的各个表项在物理上连续存储，且每一个表项长度相同，因此“物理块号”字段可以是`隐含`的。

![image-20210910111131773](https://gitee.com/aik-aid/picture/raw/master/image-20210910111131773.png)

从目录项中找到起始块号，若i>0，则查询内存中的文件分配表FAT，往后找到i号逻辑块对应的物理块号。逻辑块号转换成物理块号的过程不需要读磁盘操作。

支持随机访问的原因(和隐式的区别)

> 隐式的话，想要访问某个文件的某个逻辑块，就必须从0号逻辑块开始调入内存....一直到调入i-1号以后，才知道第i号逻辑块对应的物理块。
>
> 显示的话，想要访问某个文件的第i个逻辑块，只需要从FAT中查表，从第0号查到第i号的物理地址，然后只要将第i号逻辑块调入就行了，不需要将0-i-1从磁盘调入内存。 

优点：很方便文件拓展，不会有碎片问题，外存利用率高，并且支持随机访问。相比于隐式链接来说，地址转换时不需要访问磁盘，因此文件的访问效率更高。

缺点：文件分配表的需要占用一定的存储空间。

## 6.3 索引分配

索引分配允许文件离散地分配在各个磁盘块中，系统会`为每个文件建立一张索引表`，索引表中记录了文件的`各个逻辑块对应的物理块`（索引表的功能类似于内存管理中的页表——建立逻辑页面到物理页之间的映射关系）。索引表存放的磁盘块称为`索引块`。文件数据存放的磁盘块称为`数据块`。

用户给出要访问的逻辑块号i，操作系统找到该文件对应的目录项（FCB）

从目录项中可知索引表存放位置，将索引表从外存读入内存，并查找索引表即可知道i号逻辑块在外存中的存放位置。

可见，索引分配方式可以支持随机访问。文件拓展也很容易实现（只需要给文件分配一个空闲块，并增加一个索引表项即可）但是索引表需要占用一定的存储空间

如果一个文件的大小超过了256块，那么一个磁盘块是装不下文件的整张索引表的，如何解决这个问题？

1. 链接方案
2. 多层索引
3. 混合索引

### 6.3.1 链接方案

链接方案：如果索引表太大，一个索引块装不下，那么可以将多个索引块链接起来存放

但是效率比较低。若文件很大，索引表很长，就需要将很多个索引块链接起来。想要找到i号索引块，必须先依次读入0~i-1号索引

块，这就导致磁盘I/O次数过多，查找效率低下。

<img src="http://aikaid-img.oss-cn-shanghai.aliyuncs.com/img/image-20220419235335446.png" alt="image-20220419235335446" style="zoom:50%;" />

### 6.3.2 多层索引

多层索引：建立多层索引（原理类似于多级页表）。使第一层索引块指向第二层的索引块。还可根据文件大小的要求再建立第三层、第四层索引块。

采用K层索引结构，且顶级索引表未调入内存，则访问一个数据块只需要K + 1次读磁盘操作。

缺点：即使是小文件，访问一个数据块依然需要K+1次读磁盘。

### 6.3.3 混合索引

多种索引分配方式的结合。例如，一个文件的顶级索引表中，既包含直接地址索引（直接指向数据块），又包含一级间接索引（指向单层索引表）、还包含两级间接索引（指向两层索引表）。
优点：对于小文件来说，访问一个数据块所需的读磁盘次数更少。

![image-20210910132915969](https://gitee.com/aik-aid/picture/raw/master/image-20210910132915969.png)

# 7. 文件存储空间管理

探讨的是对空闲块磁盘块的管理

## 7.1 空闲表法

> 适用于“连续分配方式”

为外存上的所有空闲区建立一张空闲表

![image-20220419235846083](http://aikaid-img.oss-cn-shanghai.aliyuncs.com/img/image-20220419235846083.png)

**存储空间的分配与回收**

- **分配：首次适应算法、循环首次适应算法**
- **回收：考虑邻接的前后空闲区拼接合并**

## 7.2 空闲链表法

适用于离散分配的物理结构。

![image-20210910164343986](https://gitee.com/aik-aid/picture/raw/master/image-20210910164343986.png)

操作系统保存着链头、链尾指针。

如何分配：若某文件申请K个盘块，则从链头开始依次摘下K个盘块分配，并修改空闲链的链头指针。

如何回收：回收的盘块依次挂到链尾，并修改空闲链的链尾指针。

## 7.3 位示图法



![image-20210910164506665](https://gitee.com/aik-aid/picture/raw/master/image-20210910164506665.png)

如何分配：

**1）** 顺序扫描位示图，找到一个或一组代表空闲盘块的二进制位(*如果是0代表空闲盘块就找0，如果1代表空闲盘块就找1*).

**2）** 将所找到的一个或一组二进制位的行号和列号转换成相应的盘块号

**3）** 将位示图对应的一个或一组二进制位修改为代表已分配盘块的二进制位(

如何回收：

**1）** 将要回收的盘块号转换成对应的行号和列号。

**2）** 修改位示图，令对应的二进制位为代表空闲盘块的二进制位

## 7.4 成组链接法

1. 空闲盘块号栈：用来存放当前可用的一组空闲盘块的盘块号(最多含100个)，以及栈中尚有的空闲盘块号数N。顺便指出，N 还兼作栈顶指针用。例如，当N=100 时，它指向S.free(99)。由于栈是临界资源，每次只允许一个进程去访问，故系统为栈设置了一把锁。（只有这个是放在内存中的，其它是在磁盘上。）
2. 文件区中的所有空闲盘块被分成若干个组，比如，将每100 个盘块作为一组。
3. 将每一组含有的盘块总数N 和该组所有的盘块号记入其前一组的第一个盘块的S.free(0)～S.free(99)中。这样，由各组的第一个盘块可链成一条链。
4. 将第一组的盘块总数和所有的盘块号记入空闲盘块号栈中，作为当前可供分配的空闲盘块号。
5. 最末一组只有99 个盘块，其盘块号分别记入其前一组的S.free(1) ～S.free(99)中，而在S.free(0)中则存放“0”，作为空闲盘块链的结束标志。(注：最后一组的盘块数应为99，不应是100，因为这是指可供使用的空闲盘块，其编号应为(1～99)，0号中放空闲盘块链的结尾标志。)

![image-20220420001641402](http://aikaid-img.oss-cn-shanghai.aliyuncs.com/img/image-20220420001641402.png)

分配

1. 当系统要为用户分配文件所需的盘块时，须调用盘块分配过程来完成。该过程首先检查空闲盘块号栈是否上锁，如未上锁，便从栈顶取出一空闲盘块号，将与之对应的盘块分配给用户，然后将栈顶指针下移一格。
2. 若该盘块号已是栈底，即S.free(0)，这是当前栈中最后一个可分配的盘块号。由于在该盘块号所对应的盘块中记有下一组可用的盘块号，因此，须调用磁盘读过程，将栈底盘块号所对应盘块的内容读入栈中，作为新的盘块号栈的内容，并把原栈底对应的盘块分配出去(其中的有用数据已读入栈中)。
3. 然后，再分配一相应的缓冲区(作为该盘块的缓冲区)。最后，把栈中的空闲盘块数减1 并返回。

回收

- 在系统回收空闲盘块时，须调用盘块回收过程进行回收。它是将回收盘块的盘块号记入空闲盘块号栈的顶部，并执行空闲盘块数加1 操作。
- 当栈中空闲盘块号数目已达100 时，表示栈已满，便将现有栈中的100个盘块号记入新回收的盘块中，再将其盘块号作为新栈底。

# 8. 提高磁盘I/O速度的途径

# 9. 提高磁盘可靠性的技术

# 10. 数据一致性的控制
