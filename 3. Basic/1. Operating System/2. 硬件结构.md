# 1. 基本概念

冯诺依曼架构：CPU，存储器，总线，输入输出

- 早期以CPU为中心；如今以存储器为中心



用户态切换到特权态的途径

- 系统调用，执行陷入指令
- 异常，如缺页异常
- 中断

用户态切换到内核态的过程

- 保存CPU状态和错误信息到寄存器中，然后切换到内核态
- 读取内核态的中断向量表，找到对应的处理函数，执行处理函数
- 处理完后恢复上下文，返回到用户态

CPU的组成：运算器 和 控制器

- 运算器：算术逻辑单元ALU,累加寄存器ACC，通用寄存器，程序状态字寄存器PSW(进位标志，零标志，溢出标志)
- 控制器：程序计数器，指令寄存器，指令译码器，MAR(存储器地址寄存器),MDR(存储器数据寄存器)
- 还有L1 和 L2 cache也被集成到CPU里面

指令周期：

- Fetch(取得指令)：通过PC寄存器读取对应内存地址的指令
- Decode(指令译码)：对指令进行解码
- Execution(执行指令)：执行指令
- Store(数据回写)：将结果回写到寄存器或者内存中

指令的速度

- 程序的CPU执行时间 = CPU时钟周期数 ✖ 时钟周期时间
- 进一步可以拆分为： 指令数 ✖ CPI ✖ 时钟周期时间
- CPI: 每条指令的平均时钟周期数
- 时钟周期时间和CPU的主频有关，是主频(2.4GHZ)的倒数

总线特征

- 分时：同一时刻只允许有一个部件向总线发送信息
- 共享：只允许一个设备向总线发信息，但是多个部件可以从中接收

总线传输流程

- 申请分配阶段：
  - 传输请求：需要使用的主模块提出申请
  - 总线仲裁
- 寻址阶段：主模块通过总线发出本次要访问的从模块的地址以及命令，启动从模块
- 传输阶段：进行数据交换
- 结束阶段：让出总线使用权

# 2. Cache

为什么引入cache

- CPU和内存之间存在数量级上的速度差异，为了平衡CPU与内存之间的速度差异引入了cache
- cache采用SRAM，容量小，速度快。
- 利用程序的局部性原理，和内存之间的交换单位是块；和CPU的交换单位是字

Cache的结构

- 为了通过物理地址找到缓存，物理地址在逻辑上被分为Tag, Set (Index), Offset三段。
- Set段能表示的最大数目称为组，同一组下，最大支持Tag数称为路，即同一组下缓存行数目。
- 如果Set段的位数是8，那么组数就是256.

cache的替换算法

- 随机算法(RAND)

- 先进先出算法(FIFO)

- 近期最少使用(LRU)：计数单位是：访问时间

- 最不经常使用(LFU)：将一段时间内最少访问次数的换掉。计数单位是访问次数。

cache的写策略

- 写回法搭配写分配法
- 全写法搭配非写分配法

如何写出让CPU跑的更快的代码

- 提高cache的命中率可以让CPU跑的更快
- 所以需要提高 数据缓存命中率  和 指令缓存命中率

---

缓存一致性问题

- `引起背景`：现在CPU都是多核的，而cache又是各自CPU独有的，那么就可能出现不同CPU上的cache数据不一致的情况，也就是缓存不一致。而且使用的写策略往往是写回法。
- `解决要点`：写传播和事务的串行化
  - 写传播。某个CPU的核心里的cache数据更新了，必须传播到其他核心的cache
  - 事务的串行化。某个CPU核心里对数据的操作顺序，必须在其他核心看来顺序是一样的。
- `写传播的实现`: 总线嗅探。（不保证事务的串行化）
  - 当某个CPU修改cache的值后，通过总线把这个事件广播给其他核心，每个CPU都监听总线上的广播事件，当发现有广播时，就更新数据。
- `MESI协议`: Modify，Exclusive，Shared,Invalid。
  - 使用这四个状态来修饰cache line
  - 独占和共享都表示数据是干净的，最新的；只不过一个是数据被一个CPU拥有，一个是被多个CPU拥有。如果是Exclusive状态下的话，对数据进行修改不需要通知其他CPU；而在Shared状态下需要通知其他CPU，将数据修改为无效。
  - 已修改表示Cache Line的数据已经被修改但是还未写入到内存中；失效表示这个数据不是最新的，不可以从缓冲行读取该数据
  - 在已修改和独占模式的时候，修改更新其数据不需要发送广播给其他CPU核心。从而减少总线带宽压力

---

伪共享：

`出现原因` : 当多个线程同时读写同一个Cache Line的不同变量时，而导致CPU Cache失效的现象

`避免伪共享`: 通过在字段的前后进行填充(Java里面是前后各128字节)，让数据落在不同的 cache line 中。通过空间换时间

- 在linux使用 宏定义__cacheline_aligned_in_smp

- 在java中使用 @sun.misc.Contended或者RingBuffer。

# 3. Hardware Organization of a System

BUSES:

- 组成：一组电子管道(a collection of electrical conduits)
- 作用：携带信息字节在各个组件之间传递，传输的大小是`字长`

I/O Devices：

- 每个IO设备通过控制器或适配器连接到IO总线
- 适配器和控制器的作用是在IO设备和IO总线之间传输信息

Main Memory：

- 物理上来说：主存是一组DRAM
- 逻辑上来说：主存是一个线性的字节数组

Processor：

- 指令集架构：描述的是每条机器指令的效果
- 微体系架构：描述的处理器实际上是如何实现的
