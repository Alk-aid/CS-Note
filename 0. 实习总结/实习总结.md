# 1. 实习任务

实习过程中主要参与三大模块的建设: 值班系统, 诊断系统, 日志系统; 

着眼于对值班系统的智能化提升, 串联了工单 与 统一诊断平台, 日志平台

## 1.1 工单信息

- `大规模导入工单`: 通过异步任务框架, 从 Aone 平台拉取大量 issue并从中筛选出指派给块存储的工单, 并进行去重
- `提取工单元信息 并生成问题对象:` 从工单中通过 regex 提取出多种 metadata, 并对其进行验证以及扩展为问题对象, 通过实现一个 Device 接口来实现; 其中Device 接口支持懒加载, 多条件筛选, 多数据源支持
- 机器人通知: 

## 1.2 工单自动诊断

> 聚合诊断结果, 输出对用户友好的风险事件
>
> 先于客户发现问题, 输出对用户友好的风险事件

工单自动诊断: 前置客户问题诊断流程, 从而提升客户工单问题处理的质量 和 速度

- 从工单文本中提取元信息，生成问题对象，创建线程池, 并行跑多个诊断诊断器
- 获取到诊断结果以后, 进行诊断结果聚合, 输出对用户友好的风险事件
- 值班人员根据提供的诊断 summary, 可以快速定位到机器故障原因
- 同时配备工具箱, 集成值班常用工具; 简化问题处理流程



- 根据用户传过来的参数生成一个 task, 并通过 md5 计算 hash 值, 目的用于后续找到已有的 task
- 根据 param 得到对应的 metadata
- 收集需要跑的诊断器, 根据scenario收集不同的诊断器
- 将metadata 传入 诊断器 后 使用线程池并行跑诊断器(线程最多 20 个)
- 从而得到了诊断结果进行返回
- 优化: 诊断器要跑 10 多秒, 但是我们希望前端能在 5s 内保证返回
  - 5s 内未完成的诊断器, 则取消, 然后使用异步执行
  - 他们的结果是通过前端每5s 发送一次 Get 请求来获取结果 
- 优化: cache, 用于防请求洪峰, 使得短时间内同一请求参数只能生成一个诊断
  - 计算 MD5值, 从数据库中判断是否有 cached_task, 如果有则直接返回, 否则创建新的
  - 实现过程为开始将请求的全部参数都进行拦截，后面发现需要有些参数如start_time,end_time,id,timeout,by是需要剔除的 

## 1.3 工单搜索

工单搜索: 融合筛选框为搜索框(依托于 opensearch)

## 1.4 相似工单推荐

> 系统化沉淀值班数据, 通过相似工单吸收借鉴类似问题的解决思路, 从而实现化繁为简

相似工单推荐: 基于工单的描述文本，提取出关键词进行特征化

- 获取数据源:
- 文本清洗:
- 特征训练: 加载分词好的工单数据, 将文本信息向量化转化为特征, 然后使用模型进行

TODO:

- 值班人员对推荐的工单进行评价, 从而不断优化模型效率
- 对相似工单归纳出问题类型, 更进一步提升值班效率

衡量相似工单的效果: 

- 值班人员对推荐的工单进行评价, 从而不断优化模型效率
- 构建验证集, 手动打了一些标签

## 1.5 风险工单自动识别

- 预处理, 数据清洗
- 数据分词
- 向量化
- 模型训练
- 预测
- 全链路建设: 导入工单时进行自动识别, 识别为风险工单打上标签,并进行钉钉群推送
- 后续: 通过用户反馈进行自动打标功能

TODO:

- 展示混淆矩阵, 召回率, recall, accuracy, FI, PR 曲线

## 1.6 日志在线收集

在白屏 create/update 配置, 通过 sls_op dump 出配置文件; 然后首先推新加坡, 观察日志收集情况, 在全网推送

## 总结

1. 块存储值班系统模块: 

- 工单全链路: 利用任务调度框架拉取工单; 识别工单元信息提取出问题对象; 机器人通知值班组
- 工单搜索: 使用 OpenSearch 融合筛选框为搜索框,提供更灵活的搜索; 提供多种筛选以及排序
- 相似工单推荐: 利用 Machine Learning 基于余弦相似计算工单相似度, 从而推荐相似工单
- 风险工单自动识别: 利用Regex 和 ML 构建了两套框架, 利用 Regex 为ML 框架提供数据集

2. 块存储自动诊断模块:

- 工单自动诊断: 利用问题对象,并行跑诊断器;利用异步任务保证 5s 内响应; 利用 Cache 用于防请求洪峰
- 一键修复功能: 为用户提供诊断工具箱, 同时对接自定义运维, 提供一键恢复功能

3. 块存储日志在线化模块:

- 日志在线收集,汇聚: 利用 SLS 进行日志的收集, Blink 进行日志的汇聚, Drain算法 进行日志的聚类
- 对查询的扩展优化: 针对机器在多种平台使用不同数值进行表示, 实现输入一种 实际查询多种



# 2. 盘古 & 存储

1 盘古: 阿里巴巴唯一的存储核心, 支撑块存储, 文件存储, 对象存储, 表格存储


 • 提供: 多副本协议,元数据管理, 磁盘管理, 数据放置策略, 数据校验,纠删码


 2 块存储: 为云服务器提供的低时延, 持久性, 高可靠的数据块级随机存储, 通俗来讲就是云盘


 • 1.0 架构图
 • 2.0 架构图

# 3. 收获

## 3.1 项目难点

1. 并行跑诊断器, 超时任务异步调用, 提供 cache 防请求洪峰, 使短时间内同一请求参数只能生成一个诊断
2. 基于已有的代码框架, 进行
3. 日志使用 sls 收集, blink 进行汇聚, drain 进行聚类
4. 机器学习
5. 相对来说更多的是技术广度上面的内容, 未太多涉及到技术深度





1. 转换思维: 从过去以技术成长为主 -> 思考业务价值, 以客户的角度去思考价值
2. 敏捷开发: 在不确定实现效果时，先做一版出来，实际使用一次，可以帮助排除不想要的结果
3. 快速成长: 面对没接触过的技术 以及 业务, 能够快速上手
4. 注重测试: 通过单元测试保证代码的功能正确性。可以大胆地对代码进行修改。在写测试样例的时候也可以重新梳理一次思路，验证当时的实现逻辑是否有误差
4. 技术的深度 和 广度的认知:



短期规划:

- 团队方向的知识学习和积累
- 进一步融入团队, 向师兄们学习
- 技术上持续精进, 提升专项能力

长期规划:

- 在自己所在的领域做到精通
- 深挖技术的同时开始向架构倾斜, 从更高的角度看问题
- 选择适合的方向, 形成自己的优势



# 4. TODO

## 4.1 任务调度框架

Java 有哪些任务调度框架: Quartz
Python 的任务调度框架: celery 和 apscheduler
内部主要是通过魔改 apsceduler 实现的, 主要的思想是将work 拆分为job 和 task
 • task 主要是通过集成 BaseTask, 然后调用想要运行的函数, 也就是做什么
 • job 主要就是确定什么时候做, 主要就是加一个触发器, 任务触发的方式有 data, interval, cronjob 三种


apscheduler 的组件
 • triggers: 描述一个任务何时被触发，有按日期(date)、按时间间隔(interval)、按cronjob描述式三种触发方式
 • job stores: 持久化存储scheduled jobs，默认保存任务在内存中，也可将任务保存都各种数据库中，任务中的数据序列化后保存到持久化数据库，从数据库加载后又反序列化
 • executors: 执行任务模块，当任务完成时executors通知schedulers，schedulers收到后会发出一个适当的事件
 • schedulers: 任务调度器，控制器角色，通过schedulers来配置job stores和executors，添加、修改和删除任务

## 4.2 前缀树

学习前缀树, Drain, 手写一个 Drain, 前缀树和哈希表的优缺点

前缀树 和 哈希表的优缺点:
 • 优点: 最大限度地减少无谓的字符串比较，查询效率比哈希表高
 • 缺点: 空间开销大



## 4.3 Blink & SLS

学习 Blink 的汇聚, SLS 的配置

logtail 的配置:

- TODO

Blink 自动生成 sql:

- 对应每一个 logstore, 生成一个对应的 sql 语句
- 因为一个 logstore 可能会存在于多个 project 中, 所以我们需要将这些 project 中的 logstore 汇聚到一个 log-system 中

logstore 之间的区别:

- 有的有 cluster 有的无
- 有的有 topic, source 有的无



> - Blink 的时间
> - 

## 4.4 一键运维

一键恢复功能:

1. 云盘: 单云盘跨集群热迁移
2. 服务: 一键加黑 BS, CS 

- 热启动方式重启 TDC

3. 服务器:

- 一键服务器下线重装
- 服务器单机重启
- 一键提交 ag 自动替换
- 一键提交 Master 替换

## 4.5 钉钉通知

## 4.6 Machine Learing

## 4.7 存储

学习文件存储, OSS, 块存储的区别

## 4.8 日志系统

学习日志系统

## 4.9 搜索

## 4.10 hash 冲突

- 线性探测法：往下遍历直到找到下一个可用的
- 平方探测法：1，-1，4，-4这样的左右横条
- 拉链法：
- 再哈希法：同时构造多个不同的哈希函数，一个不可用再用第二个



