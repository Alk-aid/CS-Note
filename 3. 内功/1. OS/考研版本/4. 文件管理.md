# 1. 文件系统概述

1. 文件的定义：一组有意义的信息的集合
2. 文件内部应该如何被组织起来：`文件的逻辑结构`
3. 文件之间应该如何被组织起来:`目录结构`
4. 文件应该如何存放在外存中:`文件的物理结构`

# 2. 文件的逻辑结构

逻辑结构指的是：在用户看来，文件内部的数据应该是如何组织起来的

文件的逻辑结构分为

1. `无结构文件`：文件内部的数据就是一系列二进制流或者字符流的组成，又称为“流式文件”(如txt文件)
2. `有结构文件`：由一组相似的记录组成，又称“记录式文件”。每条记录又若干个数据项组成。如：
   数据库表文件。也可分为`定长文件`和`可变长文件`
   1. 顺序文件
   2. 索引文件
   3. 索引顺序文件

## 2.1 顺序文件

顺序文件：文件中的记录一个接一个地顺序排列（`逻辑上`），记录可以是`定长的`或`可变长的`。各个记录在物理上可以`顺序存储`或`链式存储`。

顺序文件还可以分为

- 串结构：记录之间的顺序与关键字无关
- 顺序结构：记录之间的顺序按关键字顺序排列

假设：已经知道了文件的起始地址（也就是第一个记录存放的位置）

思考1：能否快速找到第i个记录对应的地址？（即能否实现随机存取）

思考2：能否快速找到某个关键字对应的记录存放的位置？

![image-20210909123928145](https://gitee.com/aik-aid/picture/raw/master/image-20210909123928145.png)

## 2.2 索引文件

如果文件是可变长的，可是我们又想快速查找，那么我们就可以使用索引文件

那么就为文件建立一个索引表来加快文件检索速度。其中每条记录对应一个索引项。

索引表本身是定长记录的顺序文件。因此可以快速找到第i个记录对应的索引项。

![image-20210909124702539](https://gitee.com/aik-aid/picture/raw/master/image-20210909124702539.png)

## 2.3 索引顺序文件

索引顺序文件是索引文件和顺序文件思想的结合。索引顺序文件中，同样会为文件建立一张索引表，但不同的是：并不是每个记录对应一个索引表项，而是`一组记录对应一个索引表项`。

先索引再顺序

![image-20210910134944558](https://gitee.com/aik-aid/picture/raw/master/image-20210910134944558.png)

为了进一步提高检索效率，可以为顺序文件建立多级索引表。例如，对于一个含1000000个记录的文件，可先为该文件建立一张低级索引表，每100个记录为一组，故低级索引表中共有10000个表项（即10000个定长记录），再把这10000个定长记录分组，每组100个，为其建立顶级索引表，故顶级索引表中共有100个表项。

# 3. 文件目录

多个文件在逻辑上如何组织

![image-20210909142909715](https://gitee.com/aik-aid/picture/raw/master/image-20210909142909715.png)

## 3.1 文件控制块

**实现文件目录的关键数据结构**

目录本身就是一种**有结构文件**，由一条条记录组成。每条记录对应一个在该放在该目录下的文件。

**文件控制块**。文件控制块(FCB)是用来`存放控制文件需要的各种信息`的数据结构，以实现`“按名存取”`。

FCB的有序集合称为文件目录，一个FCB就是一个`文件目录项`。为了创建一个新文件，系统将分配一一个FCB并存放在文件目录中，成为目录项。

![image-20210909140843501](https://gitee.com/aik-aid/picture/raw/master/image-20210909140843501.png)

## 3.2 目录结构

### I 单级目录结构

单级目录实现了“按名存取”，但是不允许文件重名。

显然，单级目录结构不适用于多用户操作系统。

### II 两级目录结构

早期的多用户操作系统，采用两级目录结构。分为`主文件目录`（MFD，Master File Directory）和`用户文件目录`（UFD，User Flie Directory）。

**主文件目录**记录用户名及相应用户文件目录的存放位置

**用户文件目录**由该用户的文件FCB组成

两级目录结构允许不同用户的文件重名，也可以在目录上实现实现访问限制（检查此时登录的用户名是否匹配）。但是两级目录结构依然缺乏灵活性，用户不能对自己的文件进行分类

### III 多级目录结构(树形目录结构)

树形目录结构可以很方便地对文件进行分类，层次结构清晰，也能够更有效地进行文件的管理和保护。但是，**树形结构不便于实现文件的共享**。为此，提出了“无环图目录结构”。

### IV 无环图目录结构

![image-20210909142153777](https://gitee.com/aik-aid/picture/raw/master/image-20210909142153777.png)

**可以用不同的文件名指向同一个文件，**甚至可以指向同一个目录（共享同一目录下的所有内容）。

需要为每个共享结点设置一个**共享计数器**，用于记录此时有多少个地方在共享该结点。用户提出删除结点的请求时，只是删除该用户的FCB、并使共享计数器减1，并不会直接删除共享结点。**只有共享计数器减为0时，才删除结点。**

## 3.3 索引节点

对文件控制块的优化

![image-20210909142607594](https://gitee.com/aik-aid/picture/raw/master/image-20210909142607594.png)

当找到文件名对应的目录项时，才需要将索引结点调入内存，索引结点中记录了文件的各种信息，包括文件在外存中的存放位置，根据“存放位置”即可找到文件。

存放在外存中的索引结点称为“磁盘索引结点”，当索引结点放入内存后称为“内存索引结点”。

相比之下内存索引结点中需要增加一些信息，比如：文件是否被修改、此时有几个进程正在访问该文件等。

# 4. 文件保护

分为

- 口令保护
- 加密保护
- 访问控制

## 4.1 口令保护

为文件设置一个“口令”（如：abc112233），用户请求访问该文件时必须提供“口令”。口令一般存放在文件对应的`FCB`或`索引结点`中。用户访问文件前需要先输入“口令”，操作系统会将用户提供的口令与FCB中存储的口令进行对比，如果正确，则允许该用户访问文件

优点：保存口令的空间开销不多，验证口令的时间开销也很小。

缺点：正确的“口令”存放在系统内部，不够安全。

## 4.2 加密保护

使用某个“密码”对文件进行加密，在访问文件时需要提供正确的“密码”才能对文件进行正确的解密。

![image-20210910101619014](https://gitee.com/aik-aid/picture/raw/master/image-20210910101619014.png)

优点：保密性强，不需要在系统中存储“密码”
缺点：编码/译码，或者说加密/解密要花费一定时间。

## 4.3 访问控制

在每个文件的FCB（或索引结点）中增加一个访问控制列表（Access-Control List, ACL），该表中记
录了各个用户可以对该文件执行哪些操作。

有的计算机可能会有很多个用户，因此访问控制列表可能会很大，可以用`精简的访问列表`解决这个问题

精简的访问列表：以“组”为单位，标记各“组”用户可以对文件执行哪些操作。如：分为系统管理员、文件主、文件主的伙伴、其他用户几个分组。当某用户想要访问文件时，系统会检查该用户所属的分组是否有相应的访问权限。

# 5. 文件共享

让多个用户共享的使用同一个文件

## 5.1 硬链接(基于索引结点的共享方式)

![image-20210910102607199](https://gitee.com/aik-aid/picture/raw/master/image-20210910102607199.png)

## 5.2 软链接(基于符号链的共享方式)

![image-20210910102636663](https://gitee.com/aik-aid/picture/raw/master/image-20210910102636663.png)

用软连接要查询多级目录，会有多次磁盘I/O，因此比硬链接要慢

# 6. 文件的实现(物理结构)

![image-20210910135636622](https://gitee.com/aik-aid/picture/raw/master/image-20210910135636622.png)

探讨的是对于非空闲磁盘块的管理(文件的物理结构/文件的分配方式)

对空闲块磁盘块的管理是`文件存储空间要讨论的问题`

---

类似于内存分页，磁盘中的存储单元也会被分为一个个“块/磁盘块/物理块”。很多操作系统中，`磁盘块的大小与内存块、页面的大小相同`

内存与磁盘之间的数据交换（即读/写操作、磁盘I/O）都是以“块”为单位进行的。即每次读入一块，或每次写出一块

用户通过逻辑地址来操作自己的文件，操作系统要负责实现从逻辑地址到物理地址的映射

## 6.1 连续分配

**连续分配方式要求每个文件在磁盘上占有一组连续的块。**

用户给出要访问的文件(`按名存取`)，操作系统找到该文件对应的目录项（FCB）,从而找到起始块在物理上的地址。从而得出 **物理块号=起始块号+逻辑块号**
当然，还需要检查用户提供的逻辑块号是否合法（逻辑块号≥ 长度就不合法）

![image-20210910105409510](https://gitee.com/aik-aid/picture/raw/master/image-20210910105409510.png)

优点：

1. 支持顺序访问和直接访问（即随机访问）
2. 连续分配的文件在顺序读/写时速度最快（读取某个磁盘块时，需要移动磁头。访问的两个磁
   盘块相隔越远，移动磁头所需时间就越长。）

缺点：

1. 物理上采用连续分配的文件不方便拓展。
2. 存储空间利用率低，会产生难以利用的磁盘碎片

> 若此时文件A要拓展，需要再增加一个磁盘块（总共需要连续的4个磁盘块）。由于采用连续结构，因此文件A占用的磁盘块必须是连续的。因此只能将文件A全部“迁移”到绿色区

## 6.2 链接分配

链接分配采取`离散分配`的方式，可以为文件分配离散的磁盘块。分为`隐式链接`和`显式链接`两种。

### 6.2.1 隐式链接

隐式链接——除文件的最后一个盘块之外，每个盘块中都存有指向下一个盘块的指针。文件目录
包括文件第一块的指针和最后一块的指针。

![image-20210910105916568](https://gitee.com/aik-aid/picture/raw/master/image-20210910105916568.png)

根据文件名找到FCB，从而找到对应的物理块号。

从目录项中找到起始块号（即0号块），将0号`逻辑块`读入内存，由此知道1号`逻辑块`存放的物理块号，于是读入1号逻辑块，再找到2号逻辑块的存放位置……以此类推。因此，读入i号逻辑块，总共需要i+1次磁盘I/O。

优点：很方便文件拓展，不会有碎片问题，外存利用率高。
缺点：只支持顺序访问，不支持随机访问，查找效率低，指向下一个盘块的指针也需要耗费少量
的存储空间。

### 6.2.2 显示链接

把用于链接文件各物理块的指针显式地存放在一张表中。即文件分配表（FAT，File Allocation Tale）

注意：一**个磁盘仅设置一张FAT**（索引分配是为每个文件分配一个表）。开机时，将FAT读入内存，并`常驻内存`。FAT的各个表项在物理上连续存储，且每一个表项长度相同，因此“物理块号”字段可以是`隐含`的。

![image-20210910111131773](https://gitee.com/aik-aid/picture/raw/master/image-20210910111131773.png)

从目录项中找到起始块号，若i>0，则查询内存中的文件分配表FAT，往后找到i号逻辑块对应的物理块号。逻辑块号转换成物理块号的过程不需要读磁盘操作。

支持随机访问的原因(和隐式的区别)

> 隐式的话，想要访问某个文件的某个逻辑块，就必须从0号逻辑块开始调入内存....一直到调入i-1号以后，才知道第i号逻辑块对应的物理块。
>
> 显示的话，想要访问某个文件的第i个逻辑块，只需要从FAT中查表，从第0号查到第i号的物理地址，然后只要将第i号逻辑块调入就行了，不需要将0-i-1从磁盘调入内存。 

优点：很方便文件拓展，不会有碎片问题，外存利用率高，并且支持随机访问。相比于隐式链接来说，地址转换时不需要访问磁盘，因此文件的访问效率更高。

缺点：文件分配表的需要占用一定的存储空间。

## 6.3 索引分配

索引分配允许文件离散地分配在各个磁盘块中，系统会`为每个文件建立一张索引表`，索引表中记录了文件的`各个逻辑块对应的物理块`（索引表的功能类似于内存管理中的页表——建立逻辑页面到物理页之间的映射关系）。索引表存放的磁盘块称为`索引块`。文件数据存放的磁盘块称为`数据块`。

用户给出要访问的逻辑块号i，操作系统找到该文件对应的目录项（FCB）…
从目录项中可知索引表存放位置，将索引表从外存读入内存，并查找索引表即可知道i号逻辑块在外存中的存放位置。

可见，索引分配方式可以支持随机访问。文件拓展也很容易实现（只需要给文件分配一个空闲块，并增加一个索引表项即可）但是索引表需要占用一定的存储空间

如果一个文件的大小超过了256块，那么一个磁盘块是装不下文件的整张索引表的，如何解决这个问题？

1. 链接方案
2. 多层索引
3. 混合索引

### 6.3.1 链接方案

链接方案：如果索引表太大，一个索引块装不下，那么可以将多个索引块链接起来存放

但是效率比较低。若文件很大，索引表很长，就需要将很多个索引块链接起来。想要找到i号索引块，必须先依次读入0~i-1号索引块，这就导致磁盘I/O次数过多，查找效率低下。

### 6.3.2 多层索引

多层索引：建立多层索引（原理类似于多级页表）。使第一层索引块指向第二层的索引块。还可根据文件大小的要求再建立第三层、第四层索引块。

采用K层索引结构，且顶级索引表未调入内存，则访问一个数据块只需要K + 1次读磁盘操作。

缺点：即使是小文件，访问一个数据块依然需要K+1次读磁盘。

### 6.3.3 混合索引

多种索引分配方式的结合。例如，一个文件的顶级索引表中，既包含直接地址索引（直接指向数据块），又包含一级间接索引（指向单层索引表）、还包含两级间接索引（指向两层索引表）。
优点：对于小文件来说，访问一个数据块所需的读磁盘次数更少。

![image-20210910132915969](https://gitee.com/aik-aid/picture/raw/master/image-20210910132915969.png)

# 7. 文件存储空间管理

## 7.1 空闲表法

适用于“连续分配方式”

![image-20210910164327910](https://gitee.com/aik-aid/picture/raw/master/image-20210910164327910.png)

## 7.2 空闲链表法

适用于离散分配的物理结构。

![image-20210910164343986](https://gitee.com/aik-aid/picture/raw/master/image-20210910164343986.png)

操作系统保存着链头、链尾指针。

如何分配：若某文件申请K个盘块，则从链头开始依次摘下K个盘块分配，并修改空闲链的链头指针。

如何回收：回收的盘块依次挂到链尾，并修改空闲链的链尾指针。

## 7.3 位示图法

![image-20210910164506665](https://gitee.com/aik-aid/picture/raw/master/image-20210910164506665.png)

如何分配：若文件需要K个块

1. 顺序扫描位示图，找到K个相邻或不相邻的“0”；
2. 根据字号、位号算出对应的盘块号，将相应盘块分配给文件；
3. 将相应位设置为“1”。

如何回收：

1. 根据回收的盘块号计算出对应的字号、位号；
2. 将相应二进制位设为“0”

## 7.4 成组链接法

空闲表法、空闲链表法不适用于大型文件系统，因为空闲表或空闲链表可能过大。UNIX系统中采用了`成组链接法`对磁盘空闲块进行管理。

文件卷的目录区中专门用一个磁盘块作为“超级块”，当系统启动时需要将超级块读入内存。并且要保证内存与外存中的“超级块”数据一致

# 8. 文件的基本操作

2. ![image-20210910164947693](https://gitee.com/aik-aid/picture/raw/master/image-20210910164947693.png)

# 9. 文件系统的层次结构

![image-20210910165423177](https://gitee.com/aik-aid/picture/raw/master/image-20210910165423177.png)

![image-20210910165448575](https://gitee.com/aik-aid/picture/raw/master/image-20210910165448575.png)

# 10. 磁盘的结构

![image-20210910171540227](https://gitee.com/aik-aid/picture/raw/master/image-20210910171540227.png)

盘面：

磁道：磁盘的盘面被划分成一个个磁道。磁盘的盘面被划分成一个个磁道。

柱面：

扇区：一个磁道又被划分成一个个扇区，每个扇区就是一个“磁盘块”。各个扇区存放的数据量相同（如1KB）

---

可用（柱面号，盘面号，扇区号）来定位任意一个“磁盘块”。在“文件的物理结构”小节中，我们经常提到文件数据存放在外存中的几号块，这个块号就可以转换成（柱面号，盘面号，扇区号）的地址形式。

可根据该地址读取一个“块”

1. 根据“柱面号”移动磁臂，让磁头指向指定柱面；
2. 激活指定盘面对应的磁头；
3. 磁盘旋转的过程中，指定的扇区会从磁头下面划过，这样就完成了对指定扇区的读/写。

# 11. 磁盘调度算法

## 11.1 一次磁盘读写需要的时间

寻道时间：启动磁头臂，移动磁头到对应磁道所需要的时间.T=s+m*n

延迟时间：磁头定位到对应扇区所需要的时间：T= (1/r)*(1/2)

传输时间:假设转速是r，此次读写的字节数是b，每个磁道上的字节数是N ：T=（1/r)*(b/N)

## 11.2 调度算法

1. 先来先服务算法(FCFS):

> 优点：公平
>
> 缺点：如果磁道分散的话，则性能差

2. 最短寻找时间优先(SSTE)

> 优点：性能好，平均寻道时间短
>
> 缺点：可能有饥饿

3. 扫描算法(SCAN)

> 只有磁头移动到最内才往外移动，只有移动到最外侧才能往内移动
>
> 优点：性能好，平均寻道时间短，无饥饿
>
> 缺点：
>
> 1. 各个位置的平均响应时间不平均
> 2. 只有到达最边上才能改变方向，但是有时候处理完某一请求后，其外侧没有进程了，可以调转方向

4. 循环扫描算法(C-SCAN)

> 只有磁头移动到最内才往外移动，只有移动到最外侧才能往内移动，返回时直接快速移动到起始端，不处理任何请求
>
> 优点：比起SCAN，平均响应时间很平均
>
> 缺点：只有到达最边上才能改变方向，但是有时候处理完某一请求后，其外侧没有进程了，可以调转方向	

5. LOOK调度算法

> 在SCAN的基础上加上观察，如果在磁头移动方向没有别的请求了，就调转方向
>
> 优点：
>
> ​	比起SCAN进一步缩短了寻道时间

6. C-LOOL

> C-CSAN算法的改进，加上了LOOK

7

# 12. 减少磁盘延迟

# 13. 磁盘的管理

